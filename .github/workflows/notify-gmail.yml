name: Notify by Email (Push + PR)

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  notify-email:
    runs-on: ubuntu-latest
    steps:
      - name: Build email content
        id: build
        shell: bash
        run: |
          EVENT_TYPE="${{ github.event_name }}"
          ACTOR="${{ github.actor }}"
          REPO="${{ github.repository }}"
          REPO_URL="https://github.com/${REPO}"

          SUBJECT=""
          BODY=""

          if [ "$EVENT_TYPE" = "push" ]; then
            BRANCH="${{ github.ref_name }}"
            COMMIT_SHA="${{ github.sha }}"
            COMMIT_URL="${REPO_URL}/commit/${COMMIT_SHA}"
            # head_commit.message is available on push events
            COMMIT_MSG="${{ github.event.head_commit.message }}"

            SUBJECT="[GitHub] Push to ${REPO} (${BRANCH})"
            BODY="Push event\n\nRepo: ${REPO}\nBranch: ${BRANCH}\nBy: ${ACTOR}\n\nCommit: ${COMMIT_SHA}\nMessage: ${COMMIT_MSG}\nLink: ${COMMIT_URL}\n\nRepo: ${REPO_URL}"
          elif [ "$EVENT_TYPE" = "pull_request" ]; then
            ACTION="${{ github.event.action }}"
            PR_TITLE="${{ github.event.pull_request.title }}"
            PR_URL="${{ github.event.pull_request.html_url }}"
            PR_NUMBER="${{ github.event.pull_request.number }}"
            BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
            HEAD_BRANCH="${{ github.event.pull_request.head.ref }}"

            SUBJECT="[GitHub] PR #${PR_NUMBER} ${ACTION} in ${REPO}"
            BODY="Pull request event (${ACTION})\n\nRepo: ${REPO}\nBy: ${ACTOR}\n\nPR: #${PR_NUMBER}\nTitle: ${PR_TITLE}\nFrom: ${HEAD_BRANCH}\nInto: ${BASE_BRANCH}\nLink: ${PR_URL}\n\nRepo: ${REPO_URL}"
          else
            SUBJECT="[GitHub] Event in ${REPO}"
            BODY="Event: ${EVENT_TYPE}\nRepo: ${REPO}\nBy: ${ACTOR}\nLink: ${REPO_URL}"
          fi

          # Export for later step
          {
            echo "subject<<EOF"
            echo "$SUBJECT"
            echo "EOF"
            echo "body<<EOF"
            echo "$BODY"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Send email via Gmail SMTP
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true

          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}

          subject: ${{ steps.build.outputs.subject }}
          body: ${{ steps.build.outputs.body }}

          to: "abdulrahman.almolegi@gmail.com"
          from: "GitHub Actions <${{ secrets.GMAIL_USERNAME }}>"
